<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>routes.</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,...">
    <style>
        body {
            font-family: 'Garamond', serif;
            margin: 0;
            background-color: #fafafa;
            color: #333;
            padding: 20px;
            box-sizing: border-box;
        }

        .top-section {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            margin: 0;
            font-size: 48px; 
        }

        .back-button {
            position: absolute;
            top: 10px;
            left: 20px;
            font-size: 18px;
        }

        .filter-section {
            margin-bottom: 30px;
            text-align: center;
        }

        .filter-section label {
            display: block;
            margin-top: 20px;
            font-size: 18px;
        }

        .filter-section .custom-select {
            width: 100%;
            max-width: 500px;
            position: relative;
            margin: 0 auto;
        }

        .custom-select input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            font-family: 'Garamond', serif;
            border: 1px solid #ccc;
            box-sizing: border-box;
            cursor: pointer;
        }

        .custom-select .options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #fff;
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            display: none;
            z-index: 1;
        }

        .custom-select .options div {
            padding: 10px;
            cursor: pointer;
            font-size: 16px;
            font-family: 'Garamond', serif;
        }

        .custom-select .options div:hover {
            background-color: #f0f0f0;
        }

        .custom-select .selected-options {
            display: flex;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        .custom-select .selected-options .tag {
            background-color: #e0e0e0;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 15px;
            font-size: 16px;
            font-family: 'Garamond', serif;
            display: flex;
            align-items: center;
        }

        .custom-select .selected-options .tag .remove {
            margin-left: 10px;
            cursor: pointer;
        }

        .error-message {
            color: red;
            font-size: 14px;
            margin-top: 5px;
            font-family: 'Garamond', serif;
        }

        .success-message {
            color: green;
            font-size: 14px;
            margin-top: 5px;
            font-family: 'Garamond', serif;
        }

        .minimal-button {
            margin-top: 20px;
            font-size: 18px;
            cursor: pointer;
            font-family: 'Garamond', serif;
            background: none;
            border: 1px solid #ccc;
            padding: 10px 20px;
            transition: background-color 0.3s;
        }

        .minimal-button:hover {
            background-color: #e0e0e0;
        }

        .routes-list {
            list-style-type: none;
            padding: 0;
            max-height: 500px;
            overflow-y: auto;
        }

        .routes-list li {
            background-color: #fff;
            margin-bottom: 15px;
            padding: 20px;
            border: 1px solid #ddd;
            font-size: 18px;
            font-family: 'Garamond', serif;
            cursor: pointer;
        }

        .routes-list li:hover {
            background-color: #f0f0f0;
        }

        .city-route {
            text-decoration: underline;
            cursor: pointer;
        }

        .city-route:hover {
            text-decoration: underline;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            font-family: 'Garamond', serif;
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px; /* Increased width to accommodate more details */
            position: relative;
            font-size: 18px;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal h2 {
            margin-top: 0;
        }

        .modal ul {
            list-style-type: none;
            padding: 0;
        }

        .modal ul li {
            margin-bottom: 10px;
        }

        .results-count {
            font-size: 18px;
            margin-top: 10px;
            font-family: 'Garamond', serif;
        }

        .info-section {
            margin-top: 20px;
        }

        .info-section h3 {
            margin-bottom: 10px;
        }

        .neighboring-city {
            cursor: pointer;
            text-decoration: underline;
        }

        .neighboring-city:hover {
            text-decoration: underline;
        }

        /* Additional styling for attraction details */
        .attraction-details {
            margin-bottom: 10px;
        }

        .attraction-details strong {
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="top-section">
        <h1>routes.</h1>
        <button onclick="goBack()" class="minimal-button back-button">Back</button>
    </div>

    <div class="filter-section">
        <label for="sort-by">Sort By:</label>
        <select id="sort-by" class="minimal-input" style="font-family: 'Garamond', serif; font-size: 16px; padding: 10px; width: 100%; max-width: 500px; margin: 0 auto; border: 1px solid #ccc; box-sizing: border-box;">
            <option value="distance">Total Distance (Ascending)</option>
            <option value="distance-desc">Total Distance (Descending)</option>
        </select>

        <label for="categories">Filter By Categories (Max 3):</label>
        <div id="category-select" class="custom-select">
            <input type="text" id="category-input" placeholder="Select Categories" readonly>
            <div class="options" id="category-options"></div>
            <div class="selected-options" id="selected-categories"></div>
        </div>
        <div id="category-error" class="error-message"></div>
        <div id="category-success" class="success-message"></div>

        <button onclick="applyFilters()" class="minimal-button">Apply Filters</button>
        <button onclick="resetFilters()" class="minimal-button">Reset Filters</button>
    </div>

    <div class="results-count" id="results-count">Total Results: 0</div>

    <ul id="routes-list" class="routes-list"></ul>

    <!-- Route Modal -->
    <div id="route-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRouteModal()">&times;</span>
            <h2>Route Details</h2>
            <p id="route-info"></p>
            <ul id="route-cities-list"></ul>
            <div class="info-section">
                <h3>City Rank by Unique Attractions</h3>
                <p id="route-city-rank"></p>
            </div>
            <div class="info-section">
                <h3>Top City Categories (Entire Route)</h3>
                <ul id="route-top-categories-list"></ul>
            </div>
        </div>
    </div>

    <!-- City Modal -->
    <div id="city-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCityModal()">&times;</span>
            <h2 id="city-name">City Name</h2>
            <p id="city-coordinates">Latitude: , Longitude: </p>
            <p id="city-popdensity"></p>

            <h3>Available Subcategories (Top 20):</h3>
            <div id="subcategory-select" class="custom-select" style="position: relative;">
                <input type="text" id="subcategory-input" placeholder="Select Subcategories" readonly>
                <div class="options" id="subcategory-options" style="position: absolute;"></div>
                <div class="selected-options" id="selected-subcategories"></div>
            </div>

            <div id="attraction-filter-success" class="success-message"></div>

            <button onclick="applyAttractionFilters()" class="minimal-button">Apply Filters</button>
            <button onclick="resetAttractionFilters()" class="minimal-button">Reset Filters</button>

            <h3>Attractions:</h3>
            <ul id="attractions-list"></ul>

            <div class="info-section">
                <h3>Neighboring City Recommendations</h3>
                <p id="city-recs-info"></p>
            </div>

            <div class="info-section">
                <h3>City Route Stats</h3>
                <p id="city-route-stats"></p>
            </div>

            <div class="info-section">
                <h3>Random Attraction</h3>
                <p id="random-attraction-info"></p>
            </div>
        </div>
    </div>

    <script>
        let allRoutes = [];
        let selectedCategories = [];
        let filters = JSON.parse(localStorage.getItem('filters')) || { categories: [], sortBy: 'distance' };
        const formData = JSON.parse(localStorage.getItem('formData'));

        const sampleCategories = [
            'Event Planning & Services',
            'Local Flavor',
            'Shopping',
            'Financial Services',
            'Local Services',
            'Restaurants',
            'Hotel & Travel',
            'Arts & Entertainment',
            'Arts & Crafts',
            'Active Life',
            'Education',
            'Food',
            'Health & Medical',
            'Nightlife',
            'Beauty & Spas',
            'Home Services',
            'Mass Media',
            'Automotive',
            'Religious Organizations',
            'Public Services & Government'
        ];

        const categoryOptionsContainer = document.getElementById('category-options');
        sampleCategories.forEach(category => {
            const optionDiv = document.createElement('div');
            optionDiv.textContent = category;
            optionDiv.dataset.value = category;
            optionDiv.addEventListener('click', () => selectCategory(optionDiv));
            categoryOptionsContainer.appendChild(optionDiv);
        });

        const selectedCategoriesContainer = document.getElementById('selected-categories');
        selectedCategories = filters.categories || [];

        function updateSelectedCategories() {
            selectedCategoriesContainer.innerHTML = '';
            selectedCategories.forEach(category => {
                const tagDiv = document.createElement('div');
                tagDiv.classList.add('tag');
                tagDiv.textContent = category;
                const removeSpan = document.createElement('span');
                removeSpan.classList.add('remove');
                removeSpan.textContent = '×';
                removeSpan.addEventListener('click', () => removeCategory(category));
                tagDiv.appendChild(removeSpan);
                selectedCategoriesContainer.appendChild(tagDiv);
            });
            document.getElementById('category-input').value = '';
            document.getElementById('category-error').textContent = '';
            document.getElementById('category-success').textContent = '';
        }

        function selectCategory(optionDiv) {
            const category = optionDiv.dataset.value;
            if (!selectedCategories.includes(category)) {
                if (selectedCategories.length < 3) {
                    selectedCategories.push(category);
                    updateSelectedCategories();
                } else {
                    document.getElementById('category-error').textContent = 'You can select up to 3 categories only.';
                }
            }
        }

        function removeCategory(category) {
            selectedCategories = selectedCategories.filter(cat => cat !== category);
            updateSelectedCategories();
        }

        const categoryInput = document.getElementById('category-input');
        categoryInput.addEventListener('click', () => {
            const options = document.getElementById('category-options');
            options.style.display = (options.style.display === 'block') ? 'none' : 'block';
        });

        document.addEventListener('click', (event) => {
            if (!document.getElementById('category-select').contains(event.target)) {
                document.getElementById('category-options').style.display = 'none';
            }
        });

        document.getElementById('sort-by').value = filters.sortBy;

        async function fetchRoutesData(numInt, startCity, startState, endCity, endState) {
            const url = `http://localhost:8080/routes?numInt=${numInt}&startCity=${encodeURIComponent(startCity)}&startState=${encodeURIComponent(startState)}&endCity=${encodeURIComponent(endCity)}&endState=${encodeURIComponent(endState)}`;
            const res = await fetch(url);
            const data = await res.json();
            return data;
        }

        function convertRoutesResponse(data, numInt) {
            return data.map(row => {
                let routeCities = [];
                if (numInt === 0) {
                    routeCities = [
                        {city: row.city1, state: row.state1},
                        {city: row.city2, state: row.state2}
                    ];
                } else if (numInt === 1) {
                    routeCities = [
                        {city: row.city1, state: row.state1},
                        {city: row.city2, state: row.state2},
                        {city: row.city3, state: row.state3}
                    ];
                } else if (numInt === 2) {
                    routeCities = [
                        {city: row.city1, state: row.state1},
                        {city: row.city2, state: row.state2},
                        {city: row.city3, state: row.state3},
                        {city: row.city4, state: row.state4}
                    ];
                } else if (numInt === 3) {
                    routeCities = [
                        {city: row.city1, state: row.state1},
                        {city: row.city2, state: row.state2},
                        {city: row.city3, state: row.state3},
                        {city: row.city4, state: row.state4},
                        {city: row.city5, state: row.state5}
                    ];
                }

                return {
                    cities: routeCities,
                    distance: row.total_distance
                };
            });
        }

        async function loadRouteCityIds(route) {
            const cityIds = [];
            for (const cityObj of route.cities) {
                const cityInfoRes = await fetch(`http://localhost:8080/cities?cityName=${encodeURIComponent(cityObj.city)}&stateName=${encodeURIComponent(cityObj.state)}`);
                const cityInfo = await cityInfoRes.json();
                if (cityInfo && cityInfo.cityid) {
                    cityIds.push(cityInfo.cityid);
                }
            }
            return cityIds;
        }

        // Updated showRouteCityRank with fallback to random ordering
        async function showRouteCityRank(route) {
            const rankElement = document.getElementById('route-city-rank');
            rankElement.textContent = '';
            const cityIds = await loadRouteCityIds(route);
            if (cityIds.length === 0) {
                rankElement.textContent = 'No city ranking available.';
                return;
            }
            const rankUrl = `http://localhost:8080/cityrankbyattractions?cityIds=${cityIds.join(',')}`;
            let rankRes = await fetch(rankUrl);
            let rankData = await rankRes.json();
            if (!rankData || rankData.length === 0) {
                // Fallback to backup
                const backupUrl = `http://localhost:8080/cityrankbyattractionsbackup?cityIds=${cityIds.join(',')}`;
                rankRes = await fetch(backupUrl);
                rankData = await rankRes.json();
                if (!rankData || rankData.length === 0) {
                    // If both primary and backup fail, display random ordering
                    const shuffledCities = shuffleArray(route.cities).map(c => `${c.city}`);
                    rankElement.textContent = `City Ranking: ${shuffledCities.join(' > ')}`;
                    return;
                }
                // Assuming backupData is an array of city names
                const cities = rankData.map(cityObj => cityObj.cityname).filter(name => name); // Ensure names are present
                if (cities.length === 0) {
                    // If backup data also has no valid names, display random ordering
                    const shuffledCities = shuffleArray(route.cities).map(c => `${c.city}`);
                    rankElement.textContent = `City Ranking: ${shuffledCities.join(' > ')}`;
                } else {
                    rankElement.textContent = `Top 3 Cities by Unique Attractions: ${cities.join(' > ')}`;
                }
            } else {
                const info = rankData[0];
                const line = `Top 3 Cities by Unique Attractions: ${info.city1} > ${info.city2} > ${info.city3}. Distance: ${info.distance.toFixed(2)} miles, Total Attractions: ${info.totalnumberofattractions}`;
                rankElement.textContent = line;
            }
        }

        // Utility function to shuffle an array
        function shuffleArray(array) {
            const shuffled = array.slice();
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        async function showRouteTopCategories(route) {
            const routeTopCategoriesList = document.getElementById('route-top-categories-list');
            routeTopCategoriesList.innerHTML = '';
            const cityIds = await loadRouteCityIds(route);
            if (cityIds.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No top categories available.';
                routeTopCategoriesList.appendChild(li);
                return;
            }
            const topCatRes = await fetch(`http://localhost:8080/topCityCategories?cityIds=${cityIds.join(',')}`);
            const topCatData = await topCatRes.json();
            if (!topCatData || topCatData.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No top categories found for this route.';
                routeTopCategoriesList.appendChild(li);
            } else {
                topCatData.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>${item.category}</strong>: ${item.attractioncount} attractions<br>
                        Top Attraction: ${item.name} (${item.rating} stars)<br>
                        Address: ${item.address ? item.address : 'No address provided'}
                    `;
                    routeTopCategoriesList.appendChild(li);
                });
            }
        }

        function loadRoutes() {
            let routes = allRoutes;
            if (filters.sortBy === 'distance') {
                routes.sort((a, b) => a.distance - b.distance);
            } else if (filters.sortBy === 'distance-desc') {
                routes.sort((a, b) => b.distance - a.distance);
            }

            filters.categories = selectedCategories;
            localStorage.setItem('filters', JSON.stringify(filters));

            document.getElementById('results-count').textContent = `Total Results: ${routes.length}`;

            const routesList = document.getElementById('routes-list');
            routesList.innerHTML = '';
            routes.forEach((route, index) => {
                const cityLinks = route.cities.map((cityObj) => {
                    return `<span class="city-route" data-city="${cityObj.city}" data-state="${cityObj.state}" data-route-index="${index}">${cityObj.city}</span>`;
                });
                const li = document.createElement('li');
                li.innerHTML = `
                    Route through ${cityLinks.join(' ➔ ')}<br>
                    Total Distance: ${route.distance} miles
                `;

                li.addEventListener('click', (event) => {
                    if (!event.target.classList.contains('city-route')) {
                        openRouteModal(route);
                    }
                });

                li.querySelectorAll('.city-route').forEach(cityElement => {
                    cityElement.addEventListener('click', async (event) => {
                        event.stopPropagation();
                        const cityName = event.target.dataset.city;
                        const cityState = event.target.dataset.state;
                        const routeIndex = event.target.dataset.routeIndex;

                        const cityInfoRes = await fetch(`http://localhost:8080/cities?cityName=${encodeURIComponent(cityName)}&stateName=${encodeURIComponent(cityState)}`);
                        const cityInfo = await cityInfoRes.json();
                        if (cityInfo && cityInfo.cityid) {
                            document.getElementById('city-name').textContent = `${cityName}, ${cityState} (City ID: ${cityInfo.cityid})`;
                            openCityModal(allRoutes[routeIndex], cityName, cityState, cityInfo);
                        } else {
                            alert('City info not found.');
                        }
                    });
                });

                routesList.appendChild(li);
            });
        }

        function applyFilters() {
            filters.sortBy = document.getElementById('sort-by').value;
            document.getElementById('category-success').textContent = 'Filters applied successfully!';
            setTimeout(() => {
                document.getElementById('category-success').textContent = '';
            }, 3000);
            loadRoutes();
        }

        function resetFilters() {
            selectedCategories = [];
            updateSelectedCategories();
            filters.sortBy = 'distance';
            document.getElementById('sort-by').value = 'distance';
            loadRoutes();
        }

        function goBack() {
            window.history.back();
        }

        async function openRouteModal(route) {
            const routeModal = document.getElementById('route-modal');
            const routeInfo = document.getElementById('route-info');
            const routeCitiesList = document.getElementById('route-cities-list');

            const cityNames = route.cities.map(c => c.city);
            routeInfo.innerHTML = `
                Route through ${cityNames.join(' ➔ ')}<br>
                Total Distance: ${route.distance} miles
            `;

            routeCitiesList.innerHTML = '';
            for (const cityObj of route.cities) {
                const li = document.createElement('li');
                li.innerHTML = `<span class="city-route" data-city="${cityObj.city}" data-state="${cityObj.state}">${cityObj.city}</span>`;
                li.addEventListener('click', async () => {
                    const cityInfoRes = await fetch(`http://localhost:8080/cities?cityName=${encodeURIComponent(cityObj.city)}&stateName=${encodeURIComponent(cityObj.state)}`);
                    const cityInfo = await cityInfoRes.json();
                    if (cityInfo && cityInfo.cityid) {
                        document.getElementById('city-name').textContent = `${cityObj.city}, ${cityObj.state} (City ID: ${cityInfo.cityid})`;
                        openCityModal(route, cityObj.city, cityObj.state, cityInfo);
                    } else {
                        alert('City info not found.');
                    }
                });
                routeCitiesList.appendChild(li);
            }

            await showRouteCityRank(route);
            await showRouteTopCategories(route);

            localStorage.setItem('currentRoute', JSON.stringify(route));
            routeModal.style.display = 'block';
        }

        function closeRouteModal() {
            document.getElementById('route-modal').style.display = 'none';
        }

        let selectedSubcategories = [];
        const selectedSubcategoriesContainer = document.getElementById('selected-subcategories');

        function updateSelectedSubcategories() {
            selectedSubcategoriesContainer.innerHTML = '';
            if (selectedSubcategories.length === 0) {
                const noSubs = document.createElement('p');
                noSubs.textContent = 'No subcategories available.';
                selectedSubcategoriesContainer.appendChild(noSubs);
                return;
            }
            selectedSubcategories.forEach(subcat => {
                const tagDiv = document.createElement('div');
                tagDiv.classList.add('tag');
                tagDiv.textContent = subcat;
                const removeSpan = document.createElement('span');
                removeSpan.classList.add('remove');
                removeSpan.textContent = '×';
                removeSpan.addEventListener('click', () => removeSubcategory(subcat));
                tagDiv.appendChild(removeSpan);
                selectedSubcategoriesContainer.appendChild(tagDiv);
            });
        }

        function selectSubcategory(optionDiv) {
            const subcat = optionDiv.dataset.value;
            if (!selectedSubcategories.includes(subcat)) {
                selectedSubcategories.push(subcat);
                updateSelectedSubcategories();
            }
        }

        function removeSubcategory(subcat) {
            selectedSubcategories = selectedSubcategories.filter(sc => sc !== subcat);
            updateSelectedSubcategories();
        }

        async function openCityModal(route, cityName, cityState, cityInfo=null) {
            const cityModal = document.getElementById('city-modal');
            const cityCoordinatesElement = document.getElementById('city-coordinates');
            const cityPopDensityElement = document.getElementById('city-popdensity');
            const cityRecsInfo = document.getElementById('city-recs-info');
            const cityRouteStats = document.getElementById('city-route-stats');
            const randomAttractionInfo = document.getElementById('random-attraction-info');
            const attractionFilterSuccess = document.getElementById('attraction-filter-success');

            cityRecsInfo.textContent = '';
            cityRouteStats.textContent = '';
            randomAttractionInfo.textContent = '';
            attractionFilterSuccess.textContent = '';

            if (!cityInfo) {
                const cityInfoRes = await fetch(`http://localhost:8080/cities?cityName=${encodeURIComponent(cityName)}&stateName=${encodeURIComponent(cityState)}`);
                cityInfo = await cityInfoRes.json();
                if (!cityInfo || !cityInfo.cityid) {
                    alert('City not found in database.');
                    return;
                }
            }

            document.getElementById('city-name').textContent = `${cityName}, ${cityState} (City ID: ${cityInfo.cityid})`;
            cityCoordinatesElement.textContent = `Latitude: ${cityInfo.latitude}, Longitude: ${cityInfo.longitude}`;
            cityPopDensityElement.textContent = `Population: ${cityInfo.population}, Density: ${cityInfo.density}`;

            localStorage.setItem('lastCityId', cityInfo.cityid);
            localStorage.setItem('currentCity', cityName);
            localStorage.setItem('currentCityId', cityInfo.cityid);

            // cityrecs
            const recsRes = await fetch(`http://localhost:8080/cityrecs?cityId=${cityInfo.cityid}`);
            const recsData = await recsRes.json();
            if (recsData.length === 0) {
                cityRecsInfo.textContent = 'No neighboring city recommendations.';
            } else {
                cityRecsInfo.textContent = recsData.join(', ');
            }

            // cityNumRoutesAndAvgDist
            const routeStatsRes = await fetch(`http://localhost:8080/cityNumRoutesAndAvgDist?cityId=${cityInfo.cityid}`);
            const routeStatsData = await routeStatsRes.json();
            if (routeStatsData.length === 0) {
                cityRouteStats.textContent = 'No route stats available.';
            } else {
                const stats = routeStatsData[0];
                cityRouteStats.textContent = `This city connects to ${stats.numroutes} routes with an average distance of ${stats.avg_distance.toFixed(2)} miles.`;
            }

            // randomAttraction by state
            const randomRes = await fetch(`http://localhost:8080/randomAttraction?state=${encodeURIComponent(cityInfo.state)}`);
            const randomData = await randomRes.json();
            if (!randomData || !randomData.attraction) {
                randomAttractionInfo.textContent = 'No random attraction found.';
            } else {
                // Displaying compact details
                const address = randomData.address ? randomData.address : 'No address provided';
                randomAttractionInfo.innerHTML = `
                    <strong>${randomData.attraction}</strong><br>
                    Address: ${address}<br>
                    Rating: ${randomData.rating}<br>
                    Categories: ${randomData.categories}
                `;
            }

            // subcategories
            const catFilters = selectedCategories;
            let [category1, category2, category3] = ['', '', ''];
            if (catFilters.length > 0) category1 = catFilters[0] || '';
            if (catFilters.length > 1) category2 = catFilters[1] || '';
            if (catFilters.length > 2) category3 = catFilters[2] || '';

            const subRes = await fetch(`http://localhost:8080/subcategories?cityId=${cityInfo.cityid}&category1=${encodeURIComponent(category1)}&category2=${encodeURIComponent(category2)}&category3=${encodeURIComponent(category3)}`);
            let subData = await subRes.json();
            subData = subData.slice(0, 20);
            const subcategoryOptionsContainer = document.getElementById('subcategory-options');
            subcategoryOptionsContainer.innerHTML = '';
            if (subData.length === 0) {
                selectedSubcategories = [];
                updateSelectedSubcategories();
            } else {
                selectedSubcategories = [...new Set(subData)];
                updateSelectedSubcategories();
                subData.forEach(subcat => {
                    const optionDiv = document.createElement('div');
                    optionDiv.textContent = subcat;
                    optionDiv.dataset.value = subcat;
                    optionDiv.addEventListener('click', () => selectSubcategory(optionDiv));
                    subcategoryOptionsContainer.appendChild(optionDiv);
                });
            }

            await loadAttractions(cityInfo.cityid, category1, category2, category3);

            cityModal.style.display = 'block';
        }

        function closeCityModal() {
            document.getElementById('city-modal').style.display = 'none';
        }

        async function loadAttractions(cityId, category1, category2, category3) {
            const attractionsList = document.getElementById('attractions-list');
            const attractionFilterSuccess = document.getElementById('attraction-filter-success');
            attractionsList.innerHTML = '';
            attractionFilterSuccess.textContent = '';

            let allAttractions = [];

            try {
                // Fetch all attractions for the city
                const attractionUrl = `http://localhost:8080/attractions?cityId=${cityId}`;
                const res = await fetch(attractionUrl);
                allAttractions = await res.json();
            } catch (error) {
                console.error('Error fetching attractions:', error);
                attractionsList.innerHTML = '<li>Error loading attractions.</li>';
                return;
            }

            if (!Array.isArray(allAttractions)) {
                attractionsList.innerHTML = '<li>No attractions found.</li>';
                return;
            }

            let filteredAttractions = allAttractions;

            if (selectedCategories.length > 0) {
                // Filter attractions based on selected categories
                filteredAttractions = allAttractions.filter(attraction => {
                    if (!attraction.categories) return false;
                    const attractionCategories = attraction.categories.split(',').map(cat => cat.trim());
                    return selectedCategories.some(selectedCat => attractionCategories.includes(selectedCat));
                });
            }

            if (filteredAttractions.length === 0) {
                // If no attractions match the filters, attempt to fetch backup attractions
                try {
                    const backupUrl = `http://localhost:8080/backupAttractions?cityId=${cityId}`;
                    const backupRes = await fetch(backupUrl);
                    const backupData = await backupRes.json();

                    if (Array.isArray(backupData) && backupData.length > 0) {
                        backupData.forEach(attraction => {
                            const li = document.createElement('li');
                            const attName = attraction.attraction || attraction.name; 
                            const address = attraction.address ? attraction.address : 'No address provided';
                            const rating = attraction.rating ? attraction.rating : 'N/A';
                            const categories = attraction.categories ? attraction.categories : 'N/A';

                            li.innerHTML = `
                                <div class="attraction-details">
                                    <strong>${attName}</strong><br>
                                    Address: ${address}<br>
                                    Rating: ${rating}<br>
                                    Categories: ${categories}
                                </div>
                            `;
                            attractionsList.appendChild(li);
                        });
                        attractionFilterSuccess.textContent = 'Filters applied succesfully!';
                    } else {
                        const li = document.createElement('li');
                        li.textContent = 'No attractions found.';
                        attractionsList.appendChild(li);
                        attractionFilterSuccess.textContent = 'No attractions available to display.';
                    }
                } catch (error) {
                    console.error('Error fetching backup attractions:', error);
                    attractionsList.innerHTML = '<li>Error loading attractions.</li>';
                }
            } else {
                // Display filtered attractions
                filteredAttractions.forEach(attraction => {
                    const li = document.createElement('li');
                    const attName = attraction.attraction || attraction.name; 
                    const address = attraction.address ? attraction.address : 'No address provided';
                    const rating = attraction.rating ? attraction.rating : 'N/A';
                    const categories = attraction.categories ? attraction.categories : 'N/A';

                    li.innerHTML = `
                        <div class="attraction-details">
                            <strong>${attName}</strong><br>
                            Address: ${address}<br>
                            Rating: ${rating}<br>
                            Categories: ${categories}
                        </div>
                    `;
                    attractionsList.appendChild(li);
                });
                attractionFilterSuccess.textContent = 'Filters applied successfully!';
                setTimeout(() => {
                    attractionFilterSuccess.textContent = '';
                }, 3000);
            }
        }

        async function applyAttractionFilters() {
            const cityId = localStorage.getItem('currentCityId');
            const catFilters = selectedCategories;
            let [category1, category2, category3] = ['', '', ''];
            if (catFilters.length > 0) category1 = catFilters[0] || '';
            if (catFilters.length > 1) category2 = catFilters[1] || '';
            if (catFilters.length > 2) category3 = catFilters[2] || '';

            await loadAttractions(cityId, category1, category2, category3);
        }

        async function resetAttractionFilters() {
            const cityId = localStorage.getItem('currentCityId');
            const catFilters = selectedCategories;
            let [category1, category2, category3] = ['', '', ''];
            if (catFilters.length > 0) category1 = catFilters[0] || '';
            if (catFilters.length > 1) category2 = catFilters[1] || '';
            if (catFilters.length > 2) category3 = catFilters[2] || '';

            selectedSubcategories = [];
            updateSelectedSubcategories();

            // Reload attractions without any subcategory filters
            await loadAttractions(cityId, category1, category2, category3);
        }

        window.onload = async function() {
            if (!formData || !formData.sourceCity || !formData.sourceState || !formData.destinationCity || !formData.destinationState || formData.maxCities === undefined) {
                alert('Please fill out the form correctly.');
                window.location.href = 'index.html';
                return;
            }

            updateSelectedCategories();

            const numInt = formData.maxCities; 
            const startCity = formData.sourceCity;
            const startState = formData.sourceState;
            const endCity = formData.destinationCity;
            const endState = formData.destinationState;

            const routesData = await fetchRoutesData(numInt, startCity, startState, endCity, endState);

            if (!Array.isArray(routesData) || routesData.length === 0) {
                document.getElementById('results-count').textContent = 'No Results Found';
                return;
            }

            allRoutes = convertRoutesResponse(routesData, numInt);
            loadRoutes();
        };

        window.onclick = function(event) {
            const routeModal = document.getElementById('route-modal');
            const cityModal = document.getElementById('city-modal');
            if (event.target == routeModal) {
                closeRouteModal();
            }
            if (event.target == cityModal) {
                closeCityModal();
            }
        };
    </script>
</body>
</html>
