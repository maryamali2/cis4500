<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>routes.</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,...">
    <style>
        body {
            font-family: 'Garamond', serif;
            margin: 0;
            background-color: #fafafa;
            color: #333;
            padding: 20px;
            box-sizing: border-box;
        }

        .top-section {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            margin: 0;
            font-size: 48px; 
        }

        .back-button {
            position: absolute;
            top: 10px;
            left: 20px;
            font-size: 18px;
        }

        .filter-section {
            margin-bottom: 30px;
            text-align: center;
        }

        .filter-section label {
            display: block;
            margin-top: 20px;
            font-size: 18px;
        }

        .filter-section .custom-select {
            width: 100%;
            max-width: 500px;
            position: relative;
            margin: 0 auto;
        }

        .custom-select input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            font-family: 'Garamond', serif;
            border: 1px solid #ccc;
            box-sizing: border-box;
            cursor: pointer;
        }

        .custom-select .options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #fff;
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            display: none;
            z-index: 1;
        }

        .custom-select .options div {
            padding: 10px;
            cursor: pointer;
            font-size: 16px;
            font-family: 'Garamond', serif;
        }

        .custom-select .options div:hover {
            background-color: #f0f0f0;
        }

        .custom-select .selected-options {
            display: flex;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        .custom-select .selected-options .tag {
            background-color: #e0e0e0;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 15px;
            font-size: 16px;
            font-family: 'Garamond', serif;
            display: flex;
            align-items: center;
        }

        .custom-select .selected-options .tag .remove {
            margin-left: 10px;
            cursor: pointer;
        }

        .error-message {
            color: red;
            font-size: 14px;
            margin-top: 5px;
            font-family: 'Garamond', serif;
        }

        .minimal-button {
            margin-top: 20px;
            font-size: 18px;
            cursor: pointer;
            font-family: 'Garamond', serif;
            background: none;
            border: 1px solid #ccc;
            padding: 10px 20px;
            transition: background-color 0.3s;
        }

        .minimal-button:hover {
            background-color: #e0e0e0;
        }

        .routes-list {
            list-style-type: none;
            padding: 0;
            max-height: 500px;
            overflow-y: auto;
        }

        .routes-list li {
            background-color: #fff;
            margin-bottom: 15px;
            padding: 20px;
            border: 1px solid #ddd;
            font-size: 18px;
            font-family: 'Garamond', serif;
            cursor: pointer;
        }

        .routes-list li:hover {
            background-color: #f0f0f0;
        }

        .city-route {
            text-decoration: underline;
            cursor: pointer;
        }

        .city-route:hover {
            text-decoration: underline;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            font-family: 'Garamond', serif;
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            position: relative;
            font-size: 18px;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal h2 {
            margin-top: 0;
        }

        .modal ul {
            list-style-type: none;
            padding: 0;
        }

        .modal ul li {
            margin-bottom: 10px;
        }

        .results-count {
            font-size: 18px;
            margin-top: 10px;
            font-family: 'Garamond', serif;
        }

        @media screen and (max-height: 700px) {
            .routes-list {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="top-section">
        <h1>routes.</h1>
        <button onclick="goBack()" class="minimal-button back-button">Back</button>
    </div>

    <div class="filter-section">
        <label for="sort-by">Sort By:</label>
        <select id="sort-by" class="minimal-input" style="font-family: 'Garamond', serif; font-size: 16px; padding: 10px; width: 100%; max-width: 500px; margin: 0 auto; border: 1px solid #ccc; box-sizing: border-box;">
            <option value="distance">Total Distance (Ascending)</option>
            <option value="distance-desc">Total Distance (Descending)</option>
        </select>

        <label for="categories">Filter By Categories (Max 3):</label>
        <div id="category-select" class="custom-select">
            <input type="text" id="category-input" placeholder="Select Categories" readonly>
            <div class="options" id="category-options"></div>
            <div class="selected-options" id="selected-categories"></div>
        </div>
        <div id="category-error" class="error-message"></div>

        <button onclick="applyFilters()" class="minimal-button">Apply Filters</button>
        <button onclick="resetFilters()" class="minimal-button">Reset Filters</button>
    </div>

    <div class="results-count" id="results-count">Total Results: 0</div>

    <ul id="routes-list" class="routes-list"></ul>

    <!-- Route Details Popup -->
    <div id="route-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRouteModal()">&times;</span>
            <h2>Route Details</h2>
            <p id="route-info"></p>
            <ul id="route-cities-list"></ul>
        </div>
    </div>

    <!-- City Info Popup -->
    <div id="city-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCityModal()">&times;</span>
            <h2 id="city-name">City Name</h2>
            <p id="city-coordinates">Latitude: , Longitude: </p>

            <h3>Available Subcategories:</h3>
            <div id="subcategory-select" class="custom-select" style="position: relative;">
                <input type="text" id="subcategory-input" placeholder="Select Subcategories" readonly>
                <div class="options" id="subcategory-options" style="position: absolute;"></div>
                <div class="selected-options" id="selected-subcategories"></div>
            </div>

            <button onclick="applyAttractionFilters()" class="minimal-button">Apply Filters</button>
            <button onclick="resetAttractionFilters()" class="minimal-button">Reset Filters</button>

            <h3>Attractions:</h3>
            <ul id="attractions-list"></ul>
        </div>
    </div>

    <script>
        // JavaScript code for routes.html

        let sourceCityInfo = null;
        let destinationCityInfo = null;
        let allRoutes = [];
        let selectedCategories = [];
        let filters = JSON.parse(localStorage.getItem('filters')) || { categories: [], sortBy: 'distance' };
        const formData = JSON.parse(localStorage.getItem('formData'));

        // We use sampleCategories from the given code
        const sampleCategories = [
            'Event Planning & Services',
            'Local Flavor',
            'Shopping',
            'Financial Services',
            'Local Services',
            'Restaurants',
            'Hotel & Travel',
            'Arts & Entertainment',
            'Arts & Crafts',
            'Active Life',
            'Education',
            'Food',
            'Health & Medical',
            'Nightlife',
            'Beauty & Spas',
            'Home Services',
            'Mass Media',
            'Automotive',
            'Religious Organizations',
            'Public Services & Government'
        ];

        // Populate category options
        const categoryOptionsContainer = document.getElementById('category-options');
        sampleCategories.forEach(category => {
            const optionDiv = document.createElement('div');
            optionDiv.textContent = category;
            optionDiv.dataset.value = category;
            optionDiv.addEventListener('click', () => selectCategory(optionDiv));
            categoryOptionsContainer.appendChild(optionDiv);
        });

        // Selected categories UI update
        const selectedCategoriesContainer = document.getElementById('selected-categories');
        selectedCategories = filters.categories || [];

        function updateSelectedCategories() {
            selectedCategoriesContainer.innerHTML = '';
            selectedCategories.forEach(category => {
                const tagDiv = document.createElement('div');
                tagDiv.classList.add('tag');
                tagDiv.textContent = category;
                const removeSpan = document.createElement('span');
                removeSpan.classList.add('remove');
                removeSpan.textContent = '×';
                removeSpan.addEventListener('click', () => removeCategory(category));
                tagDiv.appendChild(removeSpan);
                selectedCategoriesContainer.appendChild(tagDiv);
            });
            document.getElementById('category-input').value = '';
            document.getElementById('category-error').textContent = '';
        }

        function selectCategory(optionDiv) {
            const category = optionDiv.dataset.value;
            if (!selectedCategories.includes(category)) {
                if (selectedCategories.length < 3) {
                    selectedCategories.push(category);
                    updateSelectedCategories();
                } else {
                    document.getElementById('category-error').textContent = 'You can select up to 3 categories only.';
                }
            }
        }

        function removeCategory(category) {
            selectedCategories = selectedCategories.filter(cat => cat !== category);
            updateSelectedCategories();
        }

        // Show/hide category options
        const categoryInput = document.getElementById('category-input');
        categoryInput.addEventListener('click', () => {
            const options = document.getElementById('category-options');
            options.style.display = (options.style.display === 'block') ? 'none' : 'block';
        });

        document.addEventListener('click', (event) => {
            if (!document.getElementById('category-select').contains(event.target)) {
                document.getElementById('category-options').style.display = 'none';
            }
        });

        document.getElementById('sort-by').value = filters.sortBy;

        async function fetchCityInfo(cityName) {
            const res = await fetch(`http://localhost:8080/cities?cityName=${encodeURIComponent(cityName)}`);
            return res.json();
        }

        async function fetchRoutesData(numInt, startCity, startState, endCity, endState) {
            const url = `http://localhost:8080/routes?numInt=${numInt}&startCity=${encodeURIComponent(startCity)}&startState=${encodeURIComponent(startState)}&endCity=${encodeURIComponent(endCity)}&endState=${encodeURIComponent(endState)}`;
            const res = await fetch(url);
            const data = await res.json();
            return data;
        }

        // Convert returned route rows to a uniform structure
        function convertRoutesResponse(data, numInt) {
            // The number of intermediate stops = numInt
            // For numInt=0: sourceCity, sourceState, destinationCity, destinationState, total_distance
            // For numInt=1: + stopCity, stopState
            // For numInt=2: + stopCity1, stopState1, stopCity2, stopState2
            // For numInt=3: + stopCity1, stopState1, stopCity2, stopState2, stopCity3, stopState3
            // We'll parse accordingly.
            const routes = data.map(row => {
                let citiesArr = [row.sourcecity];
                if (numInt >= 1) citiesArr.push(row.stopcity);
                if (numInt >= 2) citiesArr.push(row.stopcity2);
                if (numInt >= 3) citiesArr.push(row.stopcity3);
                citiesArr.push(row.destinationcity);

                // We do not have rating from DB; we can skip rating or set a placeholder
                return {
                    cities: citiesArr,
                    distance: row.total_distance,
                    rating: 4.0, // placeholder rating
                    attractions: {} // will fetch on-demand when city modal is opened
                };
            });
            return routes;
        }

        function loadRoutes() {
            let routes = allRoutes;

            // Filter by categories
            // We'll only filter if categories are selected. We must have city-level attractions to do this accurately.
            // Since we don't have route-level attraction categories pre-fetched, this could be complex.
            // For now, we won't filter by categories until a city is opened. 
            // (If needed, fetch attractions for each city and filter routes that have at least one city with desired category.)
            // To keep it simple: We skip pre-filtering by category here.

            // Sort routes
            if (filters.sortBy === 'distance') {
                routes.sort((a, b) => a.distance - b.distance);
            } else if (filters.sortBy === 'distance-desc') {
                routes.sort((a, b) => b.distance - a.distance);
            }

            // Save filters
            filters.categories = selectedCategories;
            localStorage.setItem('filters', JSON.stringify(filters));

            // Display total results
            document.getElementById('results-count').textContent = `Total Results: ${routes.length}`;

            // Display routes
            const routesList = document.getElementById('routes-list');
            routesList.innerHTML = '';
            routes.forEach((route, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    Route through ${route.cities.map((city, i) => `<span class="city-route" data-city="${city}" data-route-index="${index}">${city}</span>`).join(' ➔ ')}<br>
                    Total Distance: ${route.distance} miles<br>
                    Average Attraction Rating: ${route.rating}
                `;
                li.addEventListener('click', (event) => {
                    if (!event.target.classList.contains('city-route')) {
                        openRouteModal(route);
                    }
                });
                li.querySelectorAll('.city-route').forEach(cityElement => {
                    cityElement.addEventListener('click', (event) => {
                        event.stopPropagation(); 
                        const cityName = event.target.dataset.city;
                        const routeIndex = event.target.dataset.routeIndex;
                        openCityModal(allRoutes[routeIndex], cityName);
                    });
                });
                routesList.appendChild(li);
            });
        }

        function applyFilters() {
            filters.sortBy = document.getElementById('sort-by').value;
            loadRoutes();
        }

        function resetFilters() {
            selectedCategories = [];
            updateSelectedCategories();
            filters.sortBy = 'distance';
            document.getElementById('sort-by').value = 'distance';
            loadRoutes();
        }

        function goBack() {
            window.history.back();
        }

        // Modals
        function openRouteModal(route) {
            const routeModal = document.getElementById('route-modal');
            const routeInfo = document.getElementById('route-info');
            const routeCitiesList = document.getElementById('route-cities-list');

            routeInfo.innerHTML = `
                Route through ${route.cities.join(' ➔ ')}<br>
                Total Distance: ${route.distance} miles<br>
                Average Attraction Rating: ${route.rating}
            `;

            routeCitiesList.innerHTML = '';
            route.cities.forEach(city => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="city-route" data-city="${city}">${city}</span>`;
                li.addEventListener('click', () => {
                    openCityModal(route, city);
                });
                routeCitiesList.appendChild(li);
            });

            localStorage.setItem('currentRoute', JSON.stringify(route));
            routeModal.style.display = 'block';
        }

        function closeRouteModal() {
            document.getElementById('route-modal').style.display = 'none';
        }

        // City Modal functions
        let selectedSubcategories = [];
        const selectedSubcategoriesContainer = document.getElementById('selected-subcategories');

        function updateSelectedSubcategories() {
            selectedSubcategoriesContainer.innerHTML = '';
            selectedSubcategories.forEach(subcat => {
                const tagDiv = document.createElement('div');
                tagDiv.classList.add('tag');
                tagDiv.textContent = subcat;
                const removeSpan = document.createElement('span');
                removeSpan.classList.add('remove');
                removeSpan.textContent = '×';
                removeSpan.addEventListener('click', () => removeSubcategory(subcat));
                tagDiv.appendChild(removeSpan);
                selectedSubcategoriesContainer.appendChild(tagDiv);
            });
            document.getElementById('subcategory-input').value = '';
        }

        function selectSubcategory(optionDiv) {
            const subcat = optionDiv.dataset.value;
            if (!selectedSubcategories.includes(subcat)) {
                selectedSubcategories.push(subcat);
                updateSelectedSubcategories();
            }
        }

        function removeSubcategory(subcat) {
            selectedSubcategories = selectedSubcategories.filter(sc => sc !== subcat);
            updateSelectedSubcategories();
        }

        const subcategoryInput = document.getElementById('subcategory-input');
        subcategoryInput.addEventListener('click', () => {
            const options = document.getElementById('subcategory-options');
            options.style.display = (options.style.display === 'block') ? 'none' : 'block';
        });

        document.addEventListener('click', (event) => {
            if (!document.getElementById('subcategory-select').contains(event.target)) {
                document.getElementById('subcategory-options').style.display = 'none';
            }
        });

        async function openCityModal(route, cityName) {
            const cityModal = document.getElementById('city-modal');
            const cityNameElement = document.getElementById('city-name');
            const cityCoordinatesElement = document.getElementById('city-coordinates');

            cityNameElement.textContent = cityName;

            // Fetch city info to get coordinates and cityId
            const cityInfo = await fetchCityInfo(cityName);
            if (!cityInfo || !cityInfo.cityid) {
                alert('City not found in database.');
                return;
            }

            cityCoordinatesElement.textContent = `Latitude: ${cityInfo.latitude}, Longitude: ${cityInfo.longitude}`;

            // Fetch subcategories for this city
            const subRes = await fetch(`http://localhost:8080/subcategories?cityId=${cityInfo.cityid}`);
            const subData = await subRes.json();
            const subcategoryOptionsContainer = document.getElementById('subcategory-options');
            subcategoryOptionsContainer.innerHTML = '';
            subData.forEach(subcat => {
                const optionDiv = document.createElement('div');
                optionDiv.textContent = subcat;
                optionDiv.dataset.value = subcat;
                optionDiv.addEventListener('click', () => selectSubcategory(optionDiv));
                subcategoryOptionsContainer.appendChild(optionDiv);
            });

            // By default, select all subcategories
            selectedSubcategories = [...new Set(subData)];
            updateSelectedSubcategories();

            localStorage.setItem('currentCity', cityName);
            localStorage.setItem('currentCityId', cityInfo.cityid);

            // Load attractions
            await loadAttractions();

            cityModal.style.display = 'block';
        }

        function closeCityModal() {
            document.getElementById('city-modal').style.display = 'none';
        }

        async function loadAttractions() {
            const cityId = localStorage.getItem('currentCityId');
            const attractionsList = document.getElementById('attractions-list');

            let category1 = '';
            let category2 = '';
            let category3 = '';
            // Map selectedSubcategories to categories query. The route expects categories, not subcategories.
            // The provided route is ambiguous (it uses categories), 
            // but we only have subcategories. Let's just pick up to 3 subcategories and treat them as categories for demonstration.
            if (selectedSubcategories.length > 0) category1 = selectedSubcategories[0] || '';
            if (selectedSubcategories.length > 1) category2 = selectedSubcategories[1] || '';
            if (selectedSubcategories.length > 2) category3 = selectedSubcategories[2] || '';

            const url = `http://localhost:8080/attractions?cityId=${cityId}&category1=${encodeURIComponent(category1)}&category2=${encodeURIComponent(category2)}&category3=${encodeURIComponent(category3)}`;
            const res = await fetch(url);
            const data = await res.json();

            attractionsList.innerHTML = '';
            data.forEach(attraction => {
                const li = document.createElement('li');
                li.textContent = `${attraction.name} (${attraction.subcategories})`;
                attractionsList.appendChild(li);
            });
        }

        async function applyAttractionFilters() {
            await loadAttractions();
        }

        async function resetAttractionFilters() {
            const cityId = localStorage.getItem('currentCityId');
            // Fetch all subcategories again and select them all
            const subRes = await fetch(`http://localhost:8080/subcategories?cityId=${cityId}`);
            const subData = await subRes.json();
            selectedSubcategories = [...new Set(subData)];
            updateSelectedSubcategories();
            await loadAttractions();
        }

        window.onload = async function() {
            if (!formData || !formData.sourceCity || !formData.destinationCity || !formData.maxCities) {
                alert('Please fill out the form correctly.');
                window.location.href = 'index.html';
                return;
            }

            updateSelectedCategories();

            // Fetch city info for source and destination
            sourceCityInfo = await fetchCityInfo(formData.sourceCity);
            destinationCityInfo = await fetchCityInfo(formData.destinationCity);

            if (!sourceCityInfo || !sourceCityInfo.state || !destinationCityInfo || !destinationCityInfo.state) {
                alert('Cities not found in database.');
                window.location.href = 'index.html';
                return;
            }

            // Fetch routes
            const numInt = formData.maxCities; 
            const startCity = sourceCityInfo.city;
            const startState = sourceCityInfo.state;
            const endCity = destinationCityInfo.city;
            const endState = destinationCityInfo.state;

            const routesData = await fetchRoutesData(numInt, startCity, startState, endCity, endState);

            if (!Array.isArray(routesData) || routesData.length === 0) {
                document.getElementById('results-count').textContent = 'No Results Found';
                return;
            }

            allRoutes = convertRoutesResponse(routesData, numInt);
            loadRoutes();
        };

        window.onclick = function(event) {
            const routeModal = document.getElementById('route-modal');
            const cityModal = document.getElementById('city-modal');
            if (event.target == routeModal) {
                closeRouteModal();
            }
            if (event.target == cityModal) {
                closeCityModal();
            }
        };
    </script>
</body>
</html>
