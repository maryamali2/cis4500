<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>routes.</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,...">
    <style>
        body {
            font-family: 'Garamond', serif;
            margin: 0;
            background-color: #fafafa;
            color: #333;
            padding: 20px;
            box-sizing: border-box;
        }

        .top-section {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            margin: 0;
            font-size: 48px; 
        }

        .back-button {
            position: absolute;
            top: 10px;
            left: 20px;
            font-size: 18px;
        }

        .filter-section {
            margin-bottom: 30px;
            text-align: center;
        }

        .filter-section label {
            display: block;
            margin-top: 20px;
            font-size: 18px;
        }

        .filter-section .custom-select {
            width: 100%;
            max-width: 500px;
            position: relative;
            margin: 0 auto;
        }

        .custom-select input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            font-family: 'Garamond', serif;
            border: 1px solid #ccc;
            box-sizing: border-box;
            cursor: pointer;
        }

        .custom-select .options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #fff;
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            display: none;
            z-index: 1;
        }

        .custom-select .options div {
            padding: 10px;
            cursor: pointer;
            font-size: 16px;
            font-family: 'Garamond', serif;
        }

        .custom-select .options div:hover {
            background-color: #f0f0f0;
        }

        .custom-select .selected-options {
            display: flex;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        .custom-select .selected-options .tag {
            background-color: #e0e0e0;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 15px;
            font-size: 16px;
            font-family: 'Garamond', serif;
            display: flex;
            align-items: center;
        }

        .custom-select .selected-options .tag .remove {
            margin-left: 10px;
            cursor: pointer;
        }

        .error-message {
            color: red;
            font-size: 14px;
            margin-top: 5px;
            font-family: 'Garamond', serif;
        }

        .minimal-button {
            margin-top: 20px;
            font-size: 18px;
            cursor: pointer;
            font-family: 'Garamond', serif;
            background: none;
            border: 1px solid #ccc;
            padding: 10px 20px;
            transition: background-color 0.3s;
        }

        .minimal-button:hover {
            background-color: #e0e0e0;
        }

        .routes-list {
            list-style-type: none;
            padding: 0;
            max-height: 500px;
            overflow-y: auto;
        }

        .routes-list li {
            background-color: #fff;
            margin-bottom: 15px;
            padding: 20px;
            border: 1px solid #ddd;
            font-size: 18px;
            font-family: 'Garamond', serif;
            cursor: pointer;
        }

        .routes-list li:hover {
            background-color: #f0f0f0;
        }

        .city-route {
            text-decoration: underline;
            cursor: pointer;
        }

        .city-route:hover {
            text-decoration: underline;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            font-family: 'Garamond', serif;
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            position: relative;
            font-size: 18px;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal h2 {
            margin-top: 0;
        }

        .modal ul {
            list-style-type: none;
            padding: 0;
        }

        .modal ul li {
            margin-bottom: 10px;
        }

        .results-count {
            font-size: 18px;
            margin-top: 10px;
            font-family: 'Garamond', serif;
        }

        .info-section {
            margin-top: 20px;
        }

        .info-section h3 {
            margin-bottom: 10px;
        }

        .neighboring-city {
            cursor: pointer;
            text-decoration: underline;
        }

        .neighboring-city:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="top-section">
        <h1>routes.</h1>
        <button onclick="goBack()" class="minimal-button back-button">Back</button>
    </div>

    <div class="filter-section">
        <label for="sort-by">Sort By:</label>
        <select id="sort-by" class="minimal-input" style="font-family: 'Garamond', serif; font-size: 16px; padding: 10px; width: 100%; max-width: 500px; margin: 0 auto; border: 1px solid #ccc; box-sizing: border-box;">
            <option value="distance">Total Distance (Ascending)</option>
            <option value="distance-desc">Total Distance (Descending)</option>
        </select>

        <label for="categories">Filter By Categories (Max 3):</label>
        <div id="category-select" class="custom-select">
            <input type="text" id="category-input" placeholder="Select Categories" readonly>
            <div class="options" id="category-options"></div>
            <div class="selected-options" id="selected-categories"></div>
        </div>
        <div id="category-error" class="error-message"></div>

        <button onclick="applyFilters()" class="minimal-button">Apply Filters</button>
        <button onclick="resetFilters()" class="minimal-button">Reset Filters</button>
    </div>

    <div class="results-count" id="results-count">Total Results: 0</div>

    <ul id="routes-list" class="routes-list"></ul>

    <!-- Route modal shows route details and city rank by unique attractions -->
    <div id="route-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRouteModal()">&times;</span>
            <h2>Route Details</h2>
            <p id="route-info"></p>
            <ul id="route-cities-list"></ul>
            <div class="info-section">
                <h3>City Rank by Unique Attractions</h3>
                <p id="route-city-rank"></p>
            </div>
        </div>
    </div>

    <!-- City modal shows city details, top categories, city stats, random attraction -->
    <div id="city-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCityModal()">&times;</span>
            <h2 id="city-name">City Name</h2>
            <p id="city-coordinates">Latitude: , Longitude: </p>
            <p id="city-popdensity"></p>

            <h3>Available Subcategories (Top 20):</h3>
            <div id="subcategory-select" class="custom-select" style="position: relative;">
                <input type="text" id="subcategory-input" placeholder="Select Subcategories" readonly>
                <div class="options" id="subcategory-options" style="position: absolute;"></div>
                <div class="selected-options" id="selected-subcategories"></div>
            </div>

            <button onclick="applyAttractionFilters()" class="minimal-button">Apply Filters</button>
            <button onclick="resetAttractionFilters()" class="minimal-button">Reset Filters</button>

            <h3>Attractions:</h3>
            <ul id="attractions-list"></ul>

            <div class="info-section">
                <h3>Top City Categories</h3>
                <ul id="top-categories-list"></ul>
            </div>

            <div class="info-section">
                <h3>Neighboring City Recommendations (IDs)</h3>
                <p id="city-recs-info"></p>
            </div>

            <div class="info-section">
                <h3>City Route Stats</h3>
                <p id="city-route-stats"></p>
            </div>

            <div class="info-section">
                <h3>Random Attraction</h3>
                <p id="random-attraction-info"></p>
            </div>
        </div>
    </div>

    <script>
        let allRoutes = [];
        let selectedCategories = [];
        let filters = JSON.parse(localStorage.getItem('filters')) || { categories: [], sortBy: 'distance' };
        const formData = JSON.parse(localStorage.getItem('formData'));

        const sampleCategories = [
            'Event Planning & Services',
            'Local Flavor',
            'Shopping',
            'Financial Services',
            'Local Services',
            'Restaurants',
            'Hotel & Travel',
            'Arts & Entertainment',
            'Arts & Crafts',
            'Active Life',
            'Education',
            'Food',
            'Health & Medical',
            'Nightlife',
            'Beauty & Spas',
            'Home Services',
            'Mass Media',
            'Automotive',
            'Religious Organizations',
            'Public Services & Government'
        ];

        const categoryOptionsContainer = document.getElementById('category-options');
        sampleCategories.forEach(category => {
            const optionDiv = document.createElement('div');
            optionDiv.textContent = category;
            optionDiv.dataset.value = category;
            optionDiv.addEventListener('click', () => selectCategory(optionDiv));
            categoryOptionsContainer.appendChild(optionDiv);
        });

        const selectedCategoriesContainer = document.getElementById('selected-categories');
        selectedCategories = filters.categories || [];

        function updateSelectedCategories() {
            selectedCategoriesContainer.innerHTML = '';
            selectedCategories.forEach(category => {
                const tagDiv = document.createElement('div');
                tagDiv.classList.add('tag');
                tagDiv.textContent = category;
                const removeSpan = document.createElement('span');
                removeSpan.classList.add('remove');
                removeSpan.textContent = '×';
                removeSpan.addEventListener('click', () => removeCategory(category));
                tagDiv.appendChild(removeSpan);
                selectedCategoriesContainer.appendChild(tagDiv);
            });
            document.getElementById('category-input').value = '';
            document.getElementById('category-error').textContent = '';
        }

        function selectCategory(optionDiv) {
            const category = optionDiv.dataset.value;
            if (!selectedCategories.includes(category)) {
                if (selectedCategories.length < 3) {
                    selectedCategories.push(category);
                    updateSelectedCategories();
                } else {
                    document.getElementById('category-error').textContent = 'You can select up to 3 categories only.';
                }
            }
        }

        function removeCategory(category) {
            selectedCategories = selectedCategories.filter(cat => cat !== category);
            updateSelectedCategories();
        }

        const categoryInput = document.getElementById('category-input');
        categoryInput.addEventListener('click', () => {
            const options = document.getElementById('category-options');
            options.style.display = (options.style.display === 'block') ? 'none' : 'block';
        });

        document.addEventListener('click', (event) => {
            if (!document.getElementById('category-select').contains(event.target)) {
                document.getElementById('category-options').style.display = 'none';
            }
        });

        document.getElementById('sort-by').value = filters.sortBy;

        // Calls /routes
        async function fetchRoutesData(numInt, startCity, startState, endCity, endState) {
            const url = `http://localhost:8080/routes?numInt=${numInt}&startCity=${encodeURIComponent(startCity)}&startState=${encodeURIComponent(startState)}&endCity=${encodeURIComponent(endCity)}&endState=${encodeURIComponent(endState)}`;
            const res = await fetch(url);
            const data = await res.json();
            return data;
        }

        function convertRoutesResponse(data, numInt) {
            return data.map(row => {
                let routeCities = [];
                if (numInt === 0) {
                    routeCities = [
                        {city: row.city1, state: row.state1},
                        {city: row.city2, state: row.state2}
                    ];
                } else if (numInt === 1) {
                    routeCities = [
                        {city: row.city1, state: row.state1},
                        {city: row.city2, state: row.state2},
                        {city: row.city3, state: row.state3}
                    ];
                } else if (numInt === 2) {
                    routeCities = [
                        {city: row.city1, state: row.state1},
                        {city: row.city2, state: row.state2},
                        {city: row.city3, state: row.state3},
                        {city: row.city4, state: row.state4}
                    ];
                } else if (numInt === 3) {
                    routeCities = [
                        {city: row.city1, state: row.state1},
                        {city: row.city2, state: row.state2},
                        {city: row.city3, state: row.state3},
                        {city: row.city4, state: row.state4},
                        {city: row.city5, state: row.state5}
                    ];
                }

                return {
                    cities: routeCities,
                    distance: row.total_distance
                };
            });
        }

        async function loadRouteCityIds(route) {
            // Calls /cities for each city
            const cityIds = [];
            for (const cityObj of route.cities) {
                const cityInfoRes = await fetch(`http://localhost:8080/cities?cityName=${encodeURIComponent(cityObj.city)}&stateName=${encodeURIComponent(cityObj.state)}`);
                const cityInfo = await cityInfoRes.json();
                if (cityInfo && cityInfo.cityid) {
                    cityIds.push(cityInfo.cityid);
                }
            }
            return cityIds;
        }

        // Calls /cityrankbyattractions
        async function showRouteCityRank(route) {
            const rankElement = document.getElementById('route-city-rank');
            rankElement.textContent = '';
            const cityIds = await loadRouteCityIds(route);
            if (cityIds.length === 0) {
                rankElement.textContent = 'No city ranking available.';
                return;
            }
            const rankUrl = `http://localhost:8080/cityrankbyattractions?cityIds=${cityIds.join(',')}`;
            const rankRes = await fetch(rankUrl);
            const rankData = await rankRes.json();
            if (!rankData || rankData.length === 0) {
                rankElement.textContent = 'No city ranking available.';
            } else {
                rankElement.textContent = `Cities ranked by unique attractions: ${rankData.join(' > ')}`;
            }
        }

        function loadRoutes() {
            let routes = allRoutes;
            if (filters.sortBy === 'distance') {
                routes.sort((a, b) => a.distance - b.distance);
            } else if (filters.sortBy === 'distance-desc') {
                routes.sort((a, b) => b.distance - a.distance);
            }

            filters.categories = selectedCategories;
            localStorage.setItem('filters', JSON.stringify(filters));

            document.getElementById('results-count').textContent = `Total Results: ${routes.length}`;

            const routesList = document.getElementById('routes-list');
            routesList.innerHTML = '';
            routes.forEach((route, index) => {
                const cityLinks = route.cities.map((cityObj, i) => {
                    return `<span class="city-route" data-city="${cityObj.city}" data-state="${cityObj.state}" data-route-index="${index}">${cityObj.city}</span>`;
                });
                const li = document.createElement('li');
                li.innerHTML = `
                    Route through ${cityLinks.join(' ➔ ')}<br>
                    Total Distance: ${route.distance} miles
                `;
                // If user clicks on route li (not on city link), open route modal
                li.addEventListener('click', (event) => {
                    if (!event.target.classList.contains('city-route')) {
                        openRouteModal(route);
                    }
                });
                // If user clicks on city link, open city modal
                li.querySelectorAll('.city-route').forEach(cityElement => {
                    cityElement.addEventListener('click', async (event) => {
                        event.stopPropagation();
                        const cityName = event.target.dataset.city;
                        const cityState = event.target.dataset.state;
                        const routeIndex = event.target.dataset.routeIndex;
                        
                        // Calls /cities to get city info
                        const cityInfoRes = await fetch(`http://localhost:8080/cities?cityName=${encodeURIComponent(cityName)}&stateName=${encodeURIComponent(cityState)}`);
                        const cityInfo = await cityInfoRes.json();
                        if (cityInfo && cityInfo.cityid) {
                            document.getElementById('city-name').textContent = `${cityName}, ${cityState} (City ID: ${cityInfo.cityid})`;
                            openCityModal(allRoutes[routeIndex], cityName, cityState, cityInfo);
                        } else {
                            alert('City info not found.');
                        }
                    });
                });
                routesList.appendChild(li);
            });
        }

        function applyFilters() {
            filters.sortBy = document.getElementById('sort-by').value;
            loadRoutes();
        }

        function resetFilters() {
            selectedCategories = [];
            updateSelectedCategories();
            filters.sortBy = 'distance';
            document.getElementById('sort-by').value = 'distance';
            loadRoutes();
        }

        function goBack() {
            window.history.back();
        }

        async function openRouteModal(route) {
            const routeModal = document.getElementById('route-modal');
            const routeInfo = document.getElementById('route-info');
            const routeCitiesList = document.getElementById('route-cities-list');

            const cityNames = route.cities.map(c => c.city);
            routeInfo.innerHTML = `
                Route through ${cityNames.join(' ➔ ')}<br>
                Total Distance: ${route.distance} miles
            `;

            routeCitiesList.innerHTML = '';
            for (const cityObj of route.cities) {
                const li = document.createElement('li');
                li.innerHTML = `<span class="city-route" data-city="${cityObj.city}" data-state="${cityObj.state}">${cityObj.city}</span>`;
                li.addEventListener('click', async () => {
                    const cityInfoRes = await fetch(`http://localhost:8080/cities?cityName=${encodeURIComponent(cityObj.city)}&stateName=${encodeURIComponent(cityObj.state)}`);
                    const cityInfo = await cityInfoRes.json();
                    if (cityInfo && cityInfo.cityid) {
                        document.getElementById('city-name').textContent = `${cityObj.city}, ${cityObj.state} (City ID: ${cityInfo.cityid})`;
                        openCityModal(route, cityObj.city, cityObj.state, cityInfo);
                    } else {
                        alert('City info not found.');
                    }
                });
                routeCitiesList.appendChild(li);
            }

            await showRouteCityRank(route);

            localStorage.setItem('currentRoute', JSON.stringify(route));
            routeModal.style.display = 'block';
        }

        function closeRouteModal() {
            document.getElementById('route-modal').style.display = 'none';
        }

        let selectedSubcategories = [];
        const selectedSubcategoriesContainer = document.getElementById('selected-subcategories');

        function updateSelectedSubcategories() {
            selectedSubcategoriesContainer.innerHTML = '';
            if (selectedSubcategories.length === 0) {
                const noSubs = document.createElement('p');
                noSubs.textContent = 'No subcategories available.';
                selectedSubcategoriesContainer.appendChild(noSubs);
                return;
            }
            selectedSubcategories.forEach(subcat => {
                const tagDiv = document.createElement('div');
                tagDiv.classList.add('tag');
                tagDiv.textContent = subcat;
                const removeSpan = document.createElement('span');
                removeSpan.classList.add('remove');
                removeSpan.textContent = '×';
                removeSpan.addEventListener('click', () => removeSubcategory(subcat));
                tagDiv.appendChild(removeSpan);
                selectedSubcategoriesContainer.appendChild(tagDiv);
            });
        }

        function selectSubcategory(optionDiv) {
            const subcat = optionDiv.dataset.value;
            if (!selectedSubcategories.includes(subcat)) {
                selectedSubcategories.push(subcat);
                updateSelectedSubcategories();
            }
        }

        function removeSubcategory(subcat) {
            selectedSubcategories = selectedSubcategories.filter(sc => sc !== subcat);
            updateSelectedSubcategories();
        }

        async function openCityModal(route, cityName, cityState, cityInfo=null) {
            const cityModal = document.getElementById('city-modal');
            const cityCoordinatesElement = document.getElementById('city-coordinates');
            const cityPopDensityElement = document.getElementById('city-popdensity');
            const topCategoriesList = document.getElementById('top-categories-list');
            const cityRecsInfo = document.getElementById('city-recs-info');
            const cityRouteStats = document.getElementById('city-route-stats');
            const randomAttractionInfo = document.getElementById('random-attraction-info');

            // Clear previous info
            topCategoriesList.innerHTML = '';
            cityRecsInfo.textContent = '';
            cityRouteStats.textContent = '';
            randomAttractionInfo.textContent = '';
            // do not automatically load attractions; wait for applyAttractionFilters

            if (!cityInfo) {
                // Calls /cities
                const cityInfoRes = await fetch(`http://localhost:8080/cities?cityName=${encodeURIComponent(cityName)}&stateName=${encodeURIComponent(cityState)}`);
                cityInfo = await cityInfoRes.json();
                if (!cityInfo || !cityInfo.cityid) {
                    alert('City not found in database.');
                    return;
                }
            }
            document.getElementById('city-name').textContent = `${cityName}, ${cityState} (City ID: ${cityInfo.cityid})`;

            cityCoordinatesElement.textContent = `Latitude: ${cityInfo.latitude}, Longitude: ${cityInfo.longitude}`;
            cityPopDensityElement.textContent = `Population: ${cityInfo.population}, Density: ${cityInfo.density}`;

            localStorage.setItem('lastCityId', cityInfo.cityid);
            localStorage.setItem('currentCity', cityName);
            localStorage.setItem('currentCityId', cityInfo.cityid);

            // Calls /topCityCategories
            const topCatRes = await fetch(`http://localhost:8080/topCityCategories?cityIds=${cityInfo.cityid}`);
            const topCatData = await topCatRes.json();
            if (topCatData.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No top categories found.';
                topCategoriesList.appendChild(li);
            } else {
                topCatData.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.category}: ${item.attractioncount} attractions`;
                    topCategoriesList.appendChild(li);
                });
            }

            // Calls /cityrecs
            const recsRes = await fetch(`http://localhost:8080/cityrecs?cityId=${cityInfo.cityid}`);
            const recsData = await recsRes.json();
            if (recsData.length === 0) {
                cityRecsInfo.textContent = 'No neighboring city recommendations.';
            } else {
                // Just display the IDs as requested
                cityRecsInfo.textContent = recsData.join(', ');
            }

            // Calls /cityNumRoutesAndAvgDist
            const routeStatsRes = await fetch(`http://localhost:8080/cityNumRoutesAndAvgDist?cityId=${cityInfo.cityid}`);
            const routeStatsData = await routeStatsRes.json();
            if (routeStatsData.length === 0) {
                cityRouteStats.textContent = 'No route stats available.';
            } else {
                const stats = routeStatsData[0];
                cityRouteStats.textContent = `This city connects to ${stats.numroutes} routes with an average distance of ${stats.avg_distance.toFixed(2)} miles.`;
            }

            // Calls /randomAttraction
            const randomRes = await fetch(`http://localhost:8080/randomAttraction?cityId=${cityInfo.cityid}`);
            const randomData = await randomRes.json();
            if (!randomData || !randomData.name) {
                randomAttractionInfo.textContent = 'No random attraction found.';
            } else {
                randomAttractionInfo.textContent = `${randomData.name} (${randomData.subcategories}) - ${randomData.address}`;
            }

            // Calls /subcategories here to update subcategory filters
            const catFilters = selectedCategories;
            let [category1, category2, category3] = ['_', '_', '_'];
            if (catFilters.length > 0) category1 = catFilters[0] || '_';
            if (catFilters.length > 1) category2 = catFilters[1] || '_';
            if (catFilters.length > 2) category3 = catFilters[2] || '_';

            const subRes = await fetch(`http://localhost:8080/subcategories?cityId=${cityInfo.cityid}&category1=${encodeURIComponent(category1)}&category2=${encodeURIComponent(category2)}&category3=${encodeURIComponent(category3)}`);
            let subData = await subRes.json();
            subData = subData.slice(0, 20);
            const subcategoryOptionsContainer = document.getElementById('subcategory-options');
            subcategoryOptionsContainer.innerHTML = '';
            if (subData.length === 0) {
                selectedSubcategories = [];
                updateSelectedSubcategories();
            } else {
                selectedSubcategories = [...new Set(subData)];
                updateSelectedSubcategories();
                subData.forEach(subcat => {
                    const optionDiv = document.createElement('div');
                    optionDiv.textContent = subcat;
                    optionDiv.dataset.value = subcat;
                    optionDiv.addEventListener('click', () => selectSubcategory(optionDiv));
                    subcategoryOptionsContainer.appendChild(optionDiv);
                });
            }

            // We do NOT load attractions yet; user must click "Apply Filters"
            cityModal.style.display = 'block';
        }

        function closeCityModal() {
            document.getElementById('city-modal').style.display = 'none';
        }

        // Called when user clicks "Apply Filters" on city card
        // Calls /attractions or /subattractions or fallback to backupAttractions
        async function loadAttractions(cityId, category1, category2, category3) {
            const attractionsList = document.getElementById('attractions-list');
            attractionsList.innerHTML = '';

            let data;
            if (selectedSubcategories.length > 0) {
                let [sub1, sub2, sub3] = ['_', '_', '_'];
                for (let i = 0; i < selectedSubcategories.length; i++) {
                    if (i === 0) sub1 = selectedSubcategories[i];
                    else if (i === 1) sub2 = selectedSubcategories[i];
                    else if (i === 2) sub3 = selectedSubcategories[i];
                }

                // Calls /subattractions
                const subUrl = `http://localhost:8080/subattractions?cityId=${cityId}&subcategory1=${encodeURIComponent(sub1)}&subcategory2=${encodeURIComponent(sub2)}&subcategory3=${encodeURIComponent(sub3)}`;
                const subRes = await fetch(subUrl);
                data = await subRes.json();
                if (!data || data.length === 0) {
                    // fallback to backupAttractions
                    const backupUrl = `http://localhost:8080/backupAttractions?cityId=${cityId}`;
                    const backupRes = await fetch(backupUrl);
                    const backupData = await backupRes.json();

                    if (backupData && backupData.length > 0) {
                        backupData.forEach(attraction => {
                            const li = document.createElement('li');
                            li.textContent = `${attraction.name} (${attraction.subcategories})`;
                            attractionsList.appendChild(li);
                        });
                    } else {
                        const li = document.createElement('li');
                        li.textContent = 'No attractions found.';
                        attractionsList.appendChild(li);
                    }
                    return;
                }
                data.forEach(attraction => {
                    const li = document.createElement('li');
                    const attName = attraction.attraction || attraction.name; 
                    const attSub = attraction.subcategories;
                    li.textContent = `${attName} (${attSub})`;
                    attractionsList.appendChild(li);
                });
            } else {
                // Calls /attractions
                const attractionUrl = `http://localhost:8080/attractions?cityId=${cityId}&category1=${encodeURIComponent(category1)}&category2=${encodeURIComponent(category2)}&category3=${encodeURIComponent(category3)}`;
                const res = await fetch(attractionUrl);
                data = await res.json();
                if (!data || data.length === 0) {
                    // fallback to backupAttractions
                    const backupUrl = `http://localhost:8080/backupAttractions?cityId=${cityId}`;
                    const backupRes = await fetch(backupUrl);
                    const backupData = await backupRes.json();

                    if (backupData && backupData.length > 0) {
                        backupData.forEach(attraction => {
                            const li = document.createElement('li');
                            li.textContent = `${attraction.name} (${attraction.subcategories})`;
                            attractionsList.appendChild(li);
                        });
                    } else {
                        const li = document.createElement('li');
                        li.textContent = 'No attractions found.';
                        attractionsList.appendChild(li);
                    }
                    return;
                }
                data.forEach(attraction => {
                    const li = document.createElement('li');
                    const attName = attraction.attraction || attraction.name; 
                    const attSub = attraction.subcategories;
                    li.textContent = `${attName} (${attSub})`;
                    attractionsList.appendChild(li);
                });
            }
        }

        async function applyAttractionFilters() {
            const cityId = localStorage.getItem('currentCityId');
            const catFilters = selectedCategories;
            let [category1, category2, category3] = ['_', '_', '_'];
            if (catFilters.length > 0) category1 = catFilters[0] || '_';
            if (catFilters.length > 1) category2 = catFilters[1] || '_';
            if (catFilters.length > 2) category3 = catFilters[2] || '_';

            await loadAttractions(cityId, category1, category2, category3);
        }

        async function resetAttractionFilters() {
            const cityId = localStorage.getItem('currentCityId');
            const catFilters = selectedCategories;
            let [category1, category2, category3] = ['_', '_', '_'];
            if (catFilters.length > 0) category1 = catFilters[0] || '_';
            if (catFilters.length > 1) category2 = catFilters[1] || '_';
            if (catFilters.length > 2) category3 = catFilters[2] || '_';

            // Calls /subcategories again to reset
            const subRes = await fetch(`http://localhost:8080/subcategories?cityId=${cityId}&category1=${encodeURIComponent(category1)}&category2=${encodeURIComponent(category2)}&category3=${encodeURIComponent(category3)}`);
            let subData = await subRes.json();
            subData = subData.slice(0, 20);
            selectedSubcategories = [...new Set(subData)];
            updateSelectedSubcategories();

            // Now filters are reset, user must click 'Apply Filters' again to load attractions
        }

        window.onload = async function() {
            if (!formData || !formData.sourceCity || !formData.sourceState || !formData.destinationCity || !formData.destinationState || !formData.maxCities) {
                alert('Please fill out the form correctly.');
                window.location.href = 'index.html';
                return;
            }

            updateSelectedCategories();

            const numInt = formData.maxCities; 
            const startCity = formData.sourceCity;
            const startState = formData.sourceState;
            const endCity = formData.destinationCity;
            const endState = formData.destinationState;

            // Calls /routes
            const routesData = await fetchRoutesData(numInt, startCity, startState, endCity, endState);

            if (!Array.isArray(routesData) || routesData.length === 0) {
                document.getElementById('results-count').textContent = 'No Results Found';
                return;
            }

            allRoutes = convertRoutesResponse(routesData, numInt);
            loadRoutes();
        };

        window.onclick = function(event) {
            const routeModal = document.getElementById('route-modal');
            const cityModal = document.getElementById('city-modal');
            if (event.target == routeModal) {
                closeRouteModal();
            }
            if (event.target == cityModal) {
                closeCityModal();
            }
        };
    </script>
</body>
</html>
